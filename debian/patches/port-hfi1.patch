Description: Port hfi1 to kernel 4.9.0
Author: Brian T. Smith <bsmith@systemfabricworks.com>
Forwarded: not-needed
Last-Update: <2020-07-30>
---
This patch header follows DEP-3: http://dep.debian.net/deps/dep3/
--- a/Makefile
+++ b/Makefile
@@ -8,7 +8,8 @@
 #kbuild part of makefile
 
 CFLAGS_MODULE += -DUSE_PI_LED_ENABLE=1 -DIFS_DEB9
-obj-y := rdmavt/
+obj-y := rdmavt/ \
+	hfi1/
 
 else
 #normal makefile
--- a/compat/compat.h
+++ b/compat/compat.h
@@ -61,12 +61,12 @@
 #undef HAVE_KMALLOC_ARRAY_NODE
 #undef HAVE_IBDEV_DRIVER_ID
 #undef HAVE_IB_GET_CACHED_SUBNET_PREFIX
-#define HAVE_SECURITY_H
-#define HAVE_AIO_WRITE
+#undef HAVE_SECURITY_H
+#undef HAVE_AIO_WRITE
 #undef HAVE_DEVICE_RH
 #undef NEED_KTHREAD_HELPER_FUNCTIONS
 #undef NEED_CURRENT_TIME
-#define HAVE_RDMA_SET_DEVICE_SYSFS_GROUP
+#undef HAVE_RDMA_SET_DEVICE_SYSFS_GROUP
 #define NEED_POLL_T
 #undef HAVE_RDMA_COPY_AH_ATTR
 #define NEED_FILE_FINISH
@@ -79,19 +79,34 @@
 #define NEED_MSIX_ENTRY
 #undef HAVE_IB_QP_CREATE_USE_GFP_NOIO /* causes qp create from IPoIB to fail */
 #define NO_RDMA_AH_ATTR_TYPE
+#define NEED_MM_HELPER_FUNCTIONS
+#define NEED_PCI_REQUEST_IRQ
+#define NEED_SCHED_H
+#define NEED_EMBEDDED_DEV
+#define DEV_GET_STATS64_RETURNS_STRUCT
+#define EXPORT_HFI1_RDMA_NETDEV
 
 #include "compat_common.h"
 
 #define IB_FW_VERSION_NAME_MAX			  ETHTOOL_FWVERS_LEN
+#define OPA_SM_CLASS_VERSION                      0x80
+
+struct rdma_netdev_alloc_params {
+	size_t sizeof_priv;
+	unsigned int txqs;
+	unsigned int rxqs;
+	void *param;
+
+	int (*initialize_rdma_netdev)(struct ib_device *device, u8 port_num,
+				      struct net_device *netdev, void *param);
+};
+
 
 struct ib_ah *rdma_create_ah(struct ib_pd *pd, struct rdma_ah_attr *ah_attr);
 int rdma_destroy_ah(struct ib_ah *ah);
-
+#define rdma_set_device_sysfs_group(a, b)
 #define ib_register_device(a, b)  \
 	ib_register_device((a), (rdi->driver_f.port_callback))
-#define alloc_netdev_mqs(size, name, name_assign_type, setup, sdma, ctxts) \
-	alloc_netdev_mqs((size), (name), (setup), (sdma), (ctxts))
-
 #define rdma_create_ah(a, b, c) rdma_create_ah(a, b)
 #define rdma_destroy_ah(a, b) rdma_destroy_ah(a)
 #undef access_ok
--- a/hfi1/ipoib_main.c
+++ b/hfi1/ipoib_main.c
@@ -141,8 +141,13 @@
 	return priv->netdev_ops->ndo_stop(dev);
 }
 
-static void hfi1_ipoib_dev_get_stats64(struct net_device *dev,
-				       struct rtnl_link_stats64 *storage)
+#ifdef DEV_GET_STATS64_RETURNS_STRUCT
+static struct rtnl_link_stats64*
+#else
+static void
+#endif
+hfi1_ipoib_dev_get_stats64(struct net_device *dev,
+			   struct rtnl_link_stats64 *storage)
 {
 	struct hfi1_ipoib_dev_priv *priv = hfi1_ipoib_priv(dev);
 	u64 rx_packets = 0ull;
@@ -180,6 +185,9 @@
 	storage->rx_bytes += rx_bytes;
 	storage->tx_packets += tx_packets;
 	storage->tx_bytes += tx_bytes;
+#ifdef DEV_GET_STATS64_RETURNS_STRUCT
+	return storage;
+#endif
 }
 
 static const struct net_device_ops hfi1_ipoib_netdev_ops = {
@@ -255,6 +263,15 @@
 	hfi1_ipoib_rxq_deinit(priv->netdev);
 
 	free_percpu(priv->netstats);
+#ifdef IFS_DEB9
+	if (priv->destructor) {
+		dev->destructor = priv->destructor;
+		priv->destructor = NULL;
+		dev->destructor(dev);
+	} else {
+		dev->destructor = NULL;
+	}
+#endif
 }
 
 static void hfi1_ipoib_free_rdma_netdev(struct net_device *dev)
@@ -351,7 +368,7 @@
 	return dev;
 }
 
-#ifdef HAVE_RDMA_NETDEV_GET_PARAMS
+#if defined(HAVE_RDMA_NETDEV_GET_PARAMS) || defined(EXPORT_HFI1_RDMA_NETDEV)
 static int hfi1_ipoib_setup_rn(struct ib_device *device,
 			       u8 port_num,
 			       struct net_device *netdev,
@@ -398,6 +415,9 @@
 #ifdef HAVE_NET_DEVICE_EXTENDED
 	netdev->extended->priv_destructor = hfi1_ipoib_netdev_dtor;
 	netdev->extended->needs_free_netdev = true;
+#elif defined(IFS_DEB9)
+	priv->destructor = netdev->destructor;
+	netdev->destructor = hfi1_ipoib_netdev_dtor;
 #else
 	netdev->priv_destructor = hfi1_ipoib_netdev_dtor;
 	netdev->needs_free_netdev = true;
--- a/hfi1/ipoib_tx.c
+++ b/hfi1/ipoib_tx.c
@@ -52,6 +52,7 @@
 
 #include <linux/log2.h>
 #include <linux/circ_buf.h>
+#include <linux/vmalloc.h>
 
 #include "sdma.h"
 #include "verbs.h"
--- a/hfi1/sdma.c
+++ b/hfi1/sdma.c
@@ -1478,10 +1478,20 @@
 						&sde->descq_phys, GFP_KERNEL);
 		if (!sde->descq)
 			goto bail;
+#if defined(KVZALLOC_NODE)
 		sde->tx_ring =
 			kvzalloc_node(array_size(descq_cnt,
 						 sizeof(struct sdma_txreq *)),
 				      GFP_KERNEL, dd->node);
+#else
+		sde->tx_ring =
+			kcalloc(descq_cnt, sizeof(struct sdma_txreq *),
+				GFP_KERNEL);
+		if (!sde->tx_ring)
+			sde->tx_ring =
+				vzalloc(sizeof(struct sdma_txreq *)
+					* descq_cnt);
+#endif
 		if (!sde->tx_ring)
 			goto bail;
 	}
--- a/hfi1/hfi.h
+++ b/hfi1/hfi.h
@@ -85,7 +85,8 @@
 #include "msix.h"
 
 
-#if defined(HAVE_ALLOC_RDMA_NETDEV) || defined(HAVE_RDMA_NETDEV_GET_PARAMS)
+#if defined(HAVE_ALLOC_RDMA_NETDEV) || defined(HAVE_RDMA_NETDEV_GET_PARAMS) \
+	|| defined(EXPORT_HFI1_RDMA_NETDEV)
 #define AIP 1
 #endif
 
--- a/hfi1/verbs.c
+++ b/hfi1/verbs.c
@@ -1850,7 +1850,7 @@
 	return count;
 }
 
-#ifdef HAVE_ALLOC_RDMA_NETDEV
+#if defined(HAVE_ALLOC_RDMA_NETDEV) || defined(EXPORT_HFI1_RDMA_NETDEV)
 static struct net_device *hfi1_alloc_rn(struct ib_device *device,
 					u8 port_num,
 					enum rdma_netdev_t type,
--- a/hfi1/ipoib.h
+++ b/hfi1/ipoib.h
@@ -152,6 +152,9 @@
 	const struct net_device_ops *netdev_ops;
 	struct rvt_qp *qp;
 	struct pcpu_sw_netstats __percpu *netstats;
+#ifdef IFS_DEB9
+	void (*destructor)(struct net_device* dev);
+#endif
 };
 
 /* hfi1 ipoib rdma netdev's private data structure */
@@ -217,7 +220,7 @@
 struct sk_buff *hfi1_ipoib_prepare_skb(struct hfi1_netdev_rxq *rxq,
 				       int size, void *data);
 
-#ifdef HAVE_RDMA_NETDEV_GET_PARAMS
+#if defined(HAVE_RDMA_NETDEV_GET_PARAMS) || defined(EXPORT_HFI1_RDMA_NETDEV)
 int hfi1_ipoib_rn_get_params(struct ib_device *device,
 			     u8 port_num,
 			     enum rdma_netdev_t type,
--- a/hfi1/aspm.c
+++ b/hfi1/aspm.c
@@ -5,7 +5,7 @@
  */
 
 #include <linux/module.h>
-#include "compat_common.h"
+#include "compat.h"
 #include "aspm.h"
 
 /* Time after which the timer interrupt will re-enable ASPM */
--- a/hfi1/pcie.c
+++ b/hfi1/pcie.c
@@ -51,7 +51,7 @@
 #include <linux/vmalloc.h>
 #include <linux/aer.h>
 #include <linux/module.h>
-#include "compat_common.h"
+#include "compat.h"
 
 #include "hfi.h"
 #include "chip_registers.h"
